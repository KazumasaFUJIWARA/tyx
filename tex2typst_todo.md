# TeX to Typst 変換器 修正TODOリスト

## 現在の状況
- 改良されたパーサーが実装済み
- 基本的な変換は動作しているが、多くの問題が残存
- 出力ファイル: `sample/sample_improved.typ` (38,119文字)

## 優先度別修正項目

### 🔴 高優先度（必須修正）

#### 1. 前処理の修正
- [x] preamble全体をコメントアウトして保持

#### 2. 参照タイプの追加
- [x] `NodeType.EQREF`の定義と処理
- [x] `NodeType.CITE`の定義と処理
- [x] 参照変換器での適切な処理

#### 3. 数式変換の修正（仕様準拠）
#### 3-1. [x] 数式環境の変換
- [x] `align`環境（`$ a &= b\\ &= c $ //[formula type:align]`）
- [x] `align*`環境（`$ a &= b\\ &= c $ //[formula type:align*]`）
- [x] 独立式（`$ x^2 $ //[formula type:display]`）
- [x] 文中式（`$ x^2 $`）
- [x] `cases`環境の変換
- [x] "\"のあとに改行を挿入
- [x] ","を"\,"に置換
- [x] 数式記号のUnicode変換（基本的な実装）
	- [x] ギリシャ文字（`\alpha` → `α`）
	- [x] 数学記号（`\infty` → `∞`）
	- [x] 演算子（`\sum` → `Σ`）
	- [x] 積分（`\int` → `∫`）
- [ ] アクセントの変換（基本的な実装）
	- [x] `\dot{x}` → `$ dot(x) $`
	- [x] `\ddot{x}` → `$ dot.double(x) $`
	- [x] `\hat{x}` → `$ hat(x) $`
	- [ ] `\bar{x}` → `$ bar(x) $`
	- [ ] `\tilde{x}` → `$ tilde(x) $`
	- [ ] `\vec{x}` → `$ arrow(x) $`
- [ ] その他数式コマンド
	- [ ] `\frac`
	- [ ] `norm`
	- [ ] `abs`
- [ ] \left, \right, \bigg

#### 3-2. [ ] その他
- [ ] `_`, `^` の後が１文字の場合は`()`をつけない
- [ ] 変数の空白分離（基本的な実装）
- [ ] 関数名の扱い（基本的な実装）
- [x] メタコメントの追加（基本的な実装）

#### 4. メタデータの変換
- [ ] article.typの形式に併せて showコマンドを作成
	- [ ] title
	- [ ] author
	- [ ] date
	- [ ] abstract
	- [ ] others

### 🟡 中優先度（重要修正）

#### 4. 定理環境の改善
- [ ] 定理タイトルの正しい抽出
- [ ] ラベルの正しい抽出
- [ ] 定理内容の適切なフォーマット

#### 5. テキスト処理の改善
- [ ] 改行の適切な処理
- [ ] 段落の分離
- [ ] 空白の正規化

#### 6. 数式記号の完全対応
- [ ] ギリシャ文字の完全マッピング
- [ ] 数学演算子の完全マッピング
- [ ] 数学関数の完全マッピング

### 🟢 低優先度（品質向上）

#### 7. 出力フォーマットの改善
- [ ] Typstの適切なフォーマット
- [ ] インデントの統一
- [ ] 空行の適切な配置

#### 8. エラーハンドリング
- [ ] 未知のコマンドの処理
- [ ] 不正な構文の処理
- [ ] デバッグ情報の追加

#### 9. パフォーマンス最適化
- [ ] 正規表現の最適化
- [ ] メモリ使用量の削減
- [ ] 処理速度の向上

## 現在の問題点詳細

### 前処理の問題
```
\\newtheorem{Definition}[Theorem]{Definition}
\\newtheorem{Corollary}[Theorem]{Corollary}
```
→ これらをコメントアウトして保持する必要がある

### 参照の問題
```
// Unknown node type: NodeType.EQREF
// Unknown node type: NodeType.CITE
```
→ 未定義のノードタイプ

### 数式の問題
```
$  align(}\label(eq:DW), \begin(cases), \partial_(t)^(2) u+\partial_(t) u-\Delta u=|u|^p,, u(0)=u_(0), \partial_(t) u(0)=u_(1),, \end(cases))  $
```
→ 仕様と異なる不正な数式構文
→ 問題点:
  - align環境の変換が間違っている
  - アクセントの変換が間違っている
  - 数式記号のUnicode変換が未実装
  - メタコメントが不足
  - 変数の空白分離が未実装

## 修正順序

1. **前処理の修正** - preambleコマンドをコメントアウトして保持
2. **参照タイプの追加** - 未定義ノードタイプの解決
3. **数式変換の修正** - 基本的な数式構文の修正
4. **定理環境の改善** - 定理の正しい抽出と変換
5. **テキスト処理の改善** - フォーマットの改善
6. **その他の品質向上** - 細かな改善

## 目標

- 完全にコンパイル可能なTypstファイルの生成
- 元のTeXファイルの構造と内容の保持
- 人間が読みやすいTypstコードの生成
- ラウンドトリップ変換の可逆性

## 進捗状況

- [x] 基本的なパーサーの実装
- [x] 基本的な変換器の実装
- [x] 改良されたパーサーの実装
- [x] 前処理の修正（preambleをコメントアウトして保持）
- [x] 参照タイプの追加
- [x] 数式変換の修正
- [ ] 定理環境の改善
- [ ] テキスト処理の改善
- [ ] 最終的な品質向上

## 次のアクション

1. ✅ 前処理の修正完了（preambleをコメントアウトして保持）
2. ✅ 参照タイプの追加完了
3. ✅ 数式変換の修正完了
4. 定理環境の改善
5. テキスト処理の改善
6. 最終的な品質向上
