# TeX to Typst 変換方針

## 概要

このドキュメントでは、TeXからTypstへの変換における主要な方針と実装詳細について説明します。

## 基本的な変換方針

### 1. メタコメントによる逆変換対応

複雑な数式記号や環境については、逆変換を可能にするためメタコメントを付加します。

#### 括弧のサイズ調整

**変換時**:
```tex
\bigg( \frac{a}{b} \bigg)
\left( c \right)
```
↓
```typst
( //[command type:bigg]
 (a)/(b) ) //[command type:bigg]
( //[command type:left]
 c ) //[command type:right]
```

**復元時**:
- メタコメント`//[command type:bigg]`を検出して`\bigg(`、`\bigg)`に復元
- メタコメント`//[command type:left]`、`//[command type:right]`を検出して`\left(`、`\right)`に復元

### 2. 数式記号の変換

#### 基本的な数式記号

| TeX | Typst | 説明 |
|-----|-------|------|
| `\int` | `∫` | 積分記号 |
| `\alpha` | `α` | ギリシャ文字 |
| `\langle` | `⟨` | 左角括弧 |
| `\rangle` | `⟩` | 右角括弧 |
| `\frac{a}{b}` | `(a)/(b)` | 分数 |
| `\sqrt{a}` | `sqrt(a)` | 平方根 |

#### 上付き・下付き文字

**TeX**:
```tex
x^{2}
x_{i}
```

**Typst**:
```typst
x^(2)
x_(i)
```

### 3. 環境の変換

#### 定理環境

**TeX**:
```tex
\begin{lemma}[label]
内容
\end{lemma}
```

**Typst**:
```typst
#lemma[
内容
]
```

#### 数式環境

**align環境**:
```tex
\begin{align}
x &= a + b \\
y &= c + d
\end{align}
```

**Typst**:
```typst
$ x &= a + b \
  y &= c + d $ //[formula type:align]
```

### 4. インデントの正規化

数式中のインデントを一貫性のあるものにするため、以下の正規化を行います：

- `<tab><space>` → `<tab>` に変換
- メタコメント直後に改行とタブを追加

**例**:
```typst
# 修正前
 (sqrt(t^2-y^2))/(2) ) //[command type:bigg]

# 修正後
	(sqrt(t^2-y^2))/(2) ) //[command type:bigg]
```

## 実装詳細

### パーサー（tex_parser_improved.py）

#### 前処理（_preprocess）

1. **コメントとメタデータの除去**
2. **数式記号の変換**
3. **括弧のサイズ調整記号の処理**
4. **分数・根号の変換**

#### 要素抽出（_extract_elements）

1. **重複防止**: `processed_positions`セットで処理済み範囲を管理
2. **環境の検出**: 定理、数式、参照などの環境を正規表現で抽出

### 変換器（tex_to_typst.py）

#### 数式変換（_transform_math_content）

1. **残存コマンドの処理**
2. **上付き・下付き文字の変換**
3. **インデントの正規化**

#### テキスト変換（_transform_text_content）

1. **重複行の除去**
2. **残存TeXコマンドの削除**
3. **インデントの正規化**

## 今後の課題

### 1. ノルム記号の処理

`\bigg\| * \bigg\|`のようなノルム記号の変換については、以下の課題があります：

- **復元の困難性**: 数式の高さに応じた適切なサイズの選択が困難
- **メタコメントの複雑性**: 数式内にメタコメントを配置すると表記が壊れる

**提案される解決策**:
- 復元時に`\frac`や`\int`などの高さが変わる数式を含む場合のみ`bigg`を自動適用
- メタコメントを廃止して簡略化

### 2. パフォーマンスの最適化

- 正規表現の最適化
- 無限ループの防止
- メモリ使用量の削減

### 3. エラーハンドリング

- 不正なTeX構文の検出
- 変換失敗時の適切なエラーメッセージ
- 部分的な変換結果の保持

## まとめ

TeXからTypstへの変換は、数式の複雑さと逆変換の必要性のバランスを取ることが重要です。メタコメントによる逆変換対応を基本としつつ、実用性とパフォーマンスを考慮した実装を心がけています。
